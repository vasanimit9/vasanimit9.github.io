---
import { getCollection, render } from 'astro:content'
import Layout from '../../layouts/Layout.astro'
import PostMeta from '../../components/blog/PostMeta'
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '../../components/ui/breadcrumb'

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft)
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }))
}

const { post } = Astro.props
const { Content } = await render(post)

function calculateReadingTime(body: string): number {
  const words = body.trim().split(/\s+/).length
  return Math.max(1, Math.ceil(words / 200))
}

const readingTime = calculateReadingTime(post.body ?? '')
---

<Layout title={post.data.title} description={post.data.description}>
  <div class="sticky top-14 z-40 bg-background/80 backdrop-blur-md border-b border-border">
    <div class="px-6 py-3 max-w-2xl mx-auto">
      <Breadcrumb>
        <BreadcrumbList>
          <BreadcrumbItem>
            <BreadcrumbLink href="/">Home</BreadcrumbLink>
          </BreadcrumbItem>
          <BreadcrumbSeparator />
          <BreadcrumbItem>
            <BreadcrumbLink href="/blog/">Writing</BreadcrumbLink>
          </BreadcrumbItem>
          <BreadcrumbSeparator />
          <BreadcrumbItem>
            <BreadcrumbPage>{post.data.title}</BreadcrumbPage>
          </BreadcrumbItem>
        </BreadcrumbList>
      </Breadcrumb>
    </div>
  </div>

  <div class="px-6 py-12 max-w-2xl mx-auto">
    <article>
      <header class="mb-8">
        <h1 class="text-3xl font-bold mb-3">{post.data.title}</h1>
        <PostMeta
          date={post.data.date}
          readingTime={readingTime}
          tags={post.data.tags}
        />
      </header>

      <div class="prose dark:prose-invert max-w-none prose-headings:font-semibold prose-a:text-foreground">
        <Content />
      </div>
    </article>
  </div>
</Layout>
